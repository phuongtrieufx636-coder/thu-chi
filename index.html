<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Thu/Chi ‚Äì Mobile PLUS (Category)</title>
<style>
:root{
  --bg:#f7f9fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
  --line:#e5e7eb; --accent:#10b981; --accent2:#2563eb; --danger:#ef4444;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%}
body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--text)}
.app{min-height:100%; display:flex; flex-direction:column}
.header{position:sticky; top:0; z-index:5; background:var(--bg); padding:10px 14px 6px; border-bottom:1px solid var(--line)}
.header h2{margin:0; font-size:18px}
.content{flex:1 1 auto; padding:12px 12px 80px; max-width:960px; width:100%; margin:0 auto}
.card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
@media (max-width:560px){ .grid{grid-template-columns:1fr} }
label{font-size:12px; color:var(--muted)}
input, select, textarea{ width:100%; padding:12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff}
textarea{min-height:64px; resize:vertical}
.category{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:6px}
@media (max-width:560px){ .category{grid-template-columns:repeat(2,1fr)} }
.cat{padding:10px; text-align:center; border:1px solid var(--line); border-radius:10px; background:#f8fafc; font-size:14px; user-select:none}
.cat.active{outline:2px solid var(--accent); background:#ecfdf5}
.cat.custom{position:relative}
.cat.custom .delhint{position:absolute; inset:auto 6px 6px auto; font-size:10px; color:#ef4444; display:none}
.cat.custom.hold .delhint{display:block}
.addcat{display:flex; gap:6px; margin-top:8px}
.addcat input{flex:1}
.addcat button{white-space:nowrap}

.actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
button{padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#111827; color:#fff; font-weight:700; font-size:15px}
button.secondary{background:#fff; color:#111827}
button.blue{background:var(--accent2)}
button.green{background:var(--accent)}
button.red{background:var(--danger)}
.toolbar{display:flex; gap:8px; flex-wrap:wrap}

.pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
.pill.income{background:#ecfdf5; color:#065f46}
.pill.expense{background:#fef2f2; color:#991b1b}
table{width:100%; border-collapse:collapse; font-size:14px}
th, td{border-bottom:1px solid var(--line); padding:10px 6px; vertical-align:top}
th{background:#f9fafb; text-align:left}
.right{text-align:right}
.sum{font-weight:700}

.hidden{display:none}

/* Calendar */
.calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
.cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin:6px 0; color:var(--muted); font-weight:700; text-align:center}
.day{background:#fff;border:1px solid var(--line); border-radius:10px; min-height:84px; padding:6px; display:flex; flex-direction:column; gap:6px}
.day.other{opacity:.45}
.day h4{margin:0; font-size:13px}
.dmoney{font-size:12px}
.dmoney .inc{color:#2563eb; display:block}
.dmoney .exp{color:#dc2626; display:block}
.day:active{outline:2px solid #93c5fd}

/* Reports */
.report-top{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.switch{display:inline-flex; background:#eef2ff; border:1px solid var(--line); border-radius:999px; overflow:hidden}
.switch button{background:transparent; color:#111827; border:0; padding:8px 12px; font-weight:700}
.switch button.active{background:var(--accent2); color:#fff}
.legend{margin-top:8px}
.legend-item{display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid var(--line)}
.lbox{width:14px; height:14px; border-radius:3px; display:inline-block}

/* Bottom Tab bar */
.tabbar{position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--line); height:64px; display:grid; grid-template-columns:repeat(3,1fr); z-index:10}
.tabi{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; font-size:12px; color:#6b7280; font-weight:700}
.tabi.active{color:#2563eb}
.icon{font-size:18px; line-height:18px}

@media (max-width:420px){
  th.col-del, td.col-del{ display:none; }
  .header h2{font-size:17px}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h2>Ghi ch√©p Thu/Chi</h2>
  </div>

  <div class="content">

    <!-- INPUT -->
    <section id="page-input">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between; align-items:center">
          <div class="switch" role="tablist" aria-label="Ch·ªçn lo·∫°i ghi ch√©p">
            <button id="btnIncome" class="active" aria-selected="true">Ti·ªÅn thu</button>
            <button id="btnExpense" aria-selected="false">Ti·ªÅn chi</button>
          </div>
          <div class="toolbar">
            <button class="blue" id="exportBtn">Xu·∫•t CSV</button>
            <label class="file">
              <button class="secondary" id="importBtn">Nh·∫≠p CSV</button>
              <input type="file" id="csvInput" accept=".csv,text/csv" style="display:none">
            </label>
            <button class="red" id="clearAllBtn">Xo√°</button>
          </div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div>
            <label>Ng√†y</label>
            <input type="date" id="dateInput">
          </div>
          <div>
            <label>S·ªë ti·ªÅn (ƒë)</label>
            <input type="number" id="amountInput" min="0" step="1000" placeholder="0">
          </div>
          <div>
            <label>Ghi ch√∫</label>
            <textarea id="noteInput" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
          </div>
          <div>
            <label>Danh m·ª•c</label>
            <div class="category" id="categoryWrap"></div>
            <div class="addcat">
              <input id="newCategory" type="text" placeholder="Th√™m danh m·ª•c m·ªõi (vd: Linh ki·ªán iPhone)">
              <button class="secondary" id="addCatBtn">‚ûï Th√™m</button>
            </div>
            <div class="muted" style="font-size:12px; margin-top:6px">M·∫πo: Nh·∫•n & gi·ªØ v√†o danh m·ª•c t·ª± t·∫°o ƒë·ªÉ xo√°.</div>
          </div>
        </div>

        <div class="actions">
          <button class="green" id="submitBtn" style="flex:1">Nh·∫≠p kho·∫£n</button>
          <button class="secondary" id="resetBtn">L√†m m·ªõi</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <table id="dataTable" aria-label="Danh s√°ch thu chi">
          <thead>
            <tr>
              <th>Lo·∫°i</th>
              <th>Ng√†y</th>
              <th>Danh m·ª•c</th>
              <th>Ghi ch√∫</th>
              <th class="right">S·ªë ti·ªÅn</th>
              <th class="col-del"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="page-calendar" class="hidden">
      <div class="card">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:space-between">
          <div style="display:flex; gap:6px; align-items:center">
            <button class="secondary" id="prevMonth">&larr;</button>
            <div><strong id="calTitle">10/2025</strong> <span class="muted" id="calRange">(01‚Äì31)</span></div>
            <button class="secondary" id="nextMonth">&rarr;</button>
          </div>
          <input type="month" id="monthPicker">
        </div>

        <div class="cal-head"><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div><div>CN</div></div>
        <div class="calendar" id="calendarGrid"></div>
      </div>

      <div class="card" id="dayDetail" style="margin-top:10px">
        <h3 style="margin:0 0 6px">Chi ti·∫øt ng√†y <span id="detailDate" class="muted"></span></h3>
        <table>
          <thead><tr><th>Lo·∫°i</th><th>Danh m·ª•c</th><th>Ghi ch√∫</th><th class="right">S·ªë ti·ªÅn</th></tr></thead>
          <tbody id="detailBody"></tbody>
        </table>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="page-report" class="hidden">
      <div class="card">
        <div class="report-top">
          <div class="switch">
            <button id="btnMonthly" class="active">H√†ng th√°ng</button>
            <button id="btnYearly">H√†ng nƒÉm</button>
          </div>
          <input type="month" id="reportMonth">
          <input type="number" id="reportYear" min="1970" style="width:110px" placeholder="NƒÉm">
          <div class="switch">
            <button id="btnRepExpense" class="active">Chi ti√™u</button>
            <button id="btnRepIncome">Thu nh·∫≠p</button>
          </div>
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; align-items:flex-start">
          <canvas id="donut" width="260" height="260" style="background:#fff; border:1px solid var(--line); border-radius:10px"></canvas>
          <div style="flex:1; min-width:220px">
            <h3 style="margin:0 0 6px">Chi ti·∫øt</h3>
            <div class="legend" id="legend"></div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <div class="tabbar">
    <div class="tabi active" data-page="input"><div class="icon">üì•</div>Nh·∫≠p</div>
    <div class="tabi" data-page="calendar"><div class="icon">üìÖ</div>L·ªãch</div>
    <div class="tabi" data-page="report"><div class="icon">üìä</div>B√°o c√°o</div>
  </div>
</div>

<script>
// ===== Storage & helpers =====
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const DEF_INCOME = ["Ti·ªÅn l√†m","Ti·ªÅn l∆∞∆°ng","Ti·ªÅn ph·ª• c·∫•p","Ti·ªÅn th∆∞·ªüng","Thu nh·∫≠p ph·ª•","ƒê·∫ßu t∆∞","Thu nh·∫≠p t·∫°m th·ªùi"];
const DEF_EXPENSE = ["ƒÇn u·ªëng","Chi ti√™u h√†ng ng√†y","Linh ki·ªán","Y t·∫ø","Ti·ªÅn nh√†","Ng√¢n h√†ng","Gi·∫£i tr√≠","Kh√°c"];
let currentType = "income";
let currentCategory = DEF_INCOME[0];

function todayStr(){const d=new Date(),p=n=>String(n).padStart(2,'0');return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());}
function money(n){return Number(n||0).toLocaleString('vi-VN');}
function rows(){ try{return JSON.parse(localStorage.getItem('s11_ledger')||'[]');}catch(e){return [];} }
function save(r){ localStorage.setItem('s11_ledger', JSON.stringify(r)); }

// ----- Custom Category store -----
function loadCustom(type){
  const key = type==='income' ? 'custom_categories_income' : 'custom_categories_expense';
  try{ return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; }
}
function saveCustom(type, arr){
  const key = type==='income' ? 'custom_categories_income' : 'custom_categories_expense';
  localStorage.setItem(key, JSON.stringify(arr));
}

// ===== Navigation (bottom tabs) =====
function setPage(page){
  $$('.tabi').forEach(t=>t.classList.toggle('active', t.dataset.page===page));
  $('#page-input').classList.toggle('hidden', page!=='input');
  $('#page-calendar').classList.toggle('hidden', page!=='calendar');
  $('#page-report').classList.toggle('hidden', page!=='report');
  if(page==='calendar') renderCalendar();
  if(page==='report') renderReport();
}
$$('.tabi').forEach(t=> t.onclick=()=> setPage(t.dataset.page));

// ===== Input =====
function fullCategories(type){
  return (type==='income' ? DEF_INCOME : DEF_EXPENSE).concat(loadCustom(type));
}
function renderCats(){
  const list = fullCategories(currentType);
  const wrap = $('#categoryWrap'); wrap.innerHTML='';
  list.forEach((name,i)=>{
    const isCustom = (i >= (currentType==='income' ? DEF_INCOME.length : DEF_EXPENSE.length));
    const div=document.createElement('div'); div.className='cat'+(i===0?' active':'')+(isCustom?' custom':'');
    div.textContent=name;
    if(i===0) currentCategory=name;
    // click select
    div.onclick=()=>{ $$('.cat').forEach(c=>c.classList.remove('active')); div.classList.add('active'); currentCategory=name; };
    // long-press to delete custom only
    if(isCustom){
      const hint=document.createElement('span'); hint.className='delhint'; hint.textContent='Xo√°'; div.appendChild(hint);
      let timer=null;
      const start=()=>{ div.classList.add('hold'); timer=setTimeout(()=>{
        if(confirm('Xo√° danh m·ª•c "'+name+'"?')){
          const arr=loadCustom(currentType).filter(x=>x!==name); saveCustom(currentType, arr);
          renderCats();
        }
        div.classList.remove('hold');
      }, 700);};
      const cancel=()=>{ if(timer){ clearTimeout(timer); timer=null; } div.classList.remove('hold'); };
      div.addEventListener('touchstart', start);
      div.addEventListener('mousedown', start);
      div.addEventListener('touchend', cancel);
      div.addEventListener('touchmove', cancel);
      div.addEventListener('mouseleave', cancel);
      div.addEventListener('mouseup', cancel);
    }
    wrap.appendChild(div);
  });
}
function addCustomCategory(){
  const input=$('#newCategory');
  const name=input.value.trim();
  if(!name){ alert('Nh·∫≠p t√™n danh m·ª•c'); return; }
  const base = currentType==='income'? DEF_INCOME: DEF_EXPENSE;
  if(base.includes(name) || loadCustom(currentType).includes(name)){ alert('Danh m·ª•c ƒë√£ t·ªìn t·∫°i'); return; }
  const arr = loadCustom(currentType); arr.push(name); saveCustom(currentType, arr);
  input.value=''; renderCats();
}
$('#addCatBtn').onclick = addCustomCategory;

function renderTable(){
  const tbody = $('#dataTable tbody'); tbody.innerHTML='';
  rows().slice().reverse().forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="pill ${r.type==='income'?'income':'expense'}">${r.type==='income'?'Thu':'Chi'}</span></td>
      <td>${r.date}</td><td>${r.category||''}</td><td>${r.note||''}</td>
      <td class="right">${money(r.amount)}</td>
      <td class="right col-del"><button class="secondary" data-del="${r.id}">Xo√°</button></td>`;
    tbody.appendChild(tr);
  });
  $$('button[data-del]').forEach(b=> b.onclick=()=>{ const id=b.getAttribute('data-del'); const all=rows().filter(x=>String(x.id)!==String(id)); save(all); renderTable(); });
}
function addRow(){
  const date=$('#dateInput').value, amount=Number($('#amountInput').value||0), note=$('#noteInput').value.trim();
  if(!date){alert('Ch·ªçn ng√†y'); return;} if(amount<=0){alert('S·ªë ti·ªÅn > 0'); return;}
  const r=rows(); r.push({id:Date.now(), type:currentType, date, category:currentCategory, amount, note}); save(r);
  $('#amountInput').value=''; $('#noteInput').value=''; renderTable();
}
$('#btnIncome').onclick=()=>{ currentType='income'; $('#btnIncome').classList.add('active'); $('#btnExpense').classList.remove('active'); renderCats(); };
$('#btnExpense').onclick=()=>{ currentType='expense'; $('#btnExpense').classList.add('active'); $('#btnIncome').classList.remove('active'); renderCats(); };
$('#submitBtn').onclick=addRow;
$('#resetBtn').onclick=()=>{ $('#amountInput').value=''; $('#noteInput').value=''; };
$('#clearAllBtn').onclick=()=>{ if(confirm('Xo√° to√†n b·ªô?')){ save([]); renderTable(); } };

// CSV
function toCSV(rs){ const headers=['type','date','category','amount','note']; const esc=s=>s==null?'':(/[",\n]/.test(String(s))?'"'+String(s).replace(/"/g,'""')+'"':String(s)); const out=[headers.join(',')]; rs.forEach(r=> out.push(headers.map(h=>esc(r[h])).join(','))); return out.join('\n'); }
function parseCSV(t){ const rows=[]; let cur=[],cell='',inQ=false; for(let i=0;i<t.length;i++){const ch=t[i]; if(inQ){ if(ch=='"'){ if(t[i+1]=='"'){cell+='"';i++;} else inQ=false;} else cell+=ch; } else { if(ch=='"')inQ=true; else if(ch==','){cur.push(cell);cell='';} else if(ch=='\n'||ch=='\r'){ if(ch=='\r'&&t[i+1]=='\n')i++; cur.push(cell);cell=''; if(cur.some(x=>x!=='')) rows.push(cur); cur=[];} else cell+=ch; } } if(cell.length||cur.length){cur.push(cell); rows.push(cur);} return rows;}
$('#exportBtn').onclick=()=>{ const blob=new Blob([toCSV(rows())],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='so_thu_chi.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0); };
$('#csvInput').addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const arr=parseCSV(r.result||''); if(!arr.length) return alert('CSV r·ªóng'); const header=arr[0]; const need=['type','date','category','amount','note']; if(!need.every(h=>header.includes(h))) return alert('CSV sai header'); const idx=Object.fromEntries(header.map((h,i)=>[h,i])); const all=rows(); for(let i=1;i<arr.length;i++){ const x=arr[i]; if(!x||!x.length) continue; const row={id:Date.now()+i, type:(x[idx.type]||'income').trim(), date:(x[idx.date]||todayStr()).trim(), category:x[idx.category]||'', amount:Number(x[idx.amount]||0), note:x[idx.note]||''}; if(!row.amount||!row.date) continue; all.push(row);} save(all); renderTable(); alert('Nh·∫≠p CSV xong'); }; r.readAsText(f,'utf-8'); e.target.value=''; });
$('#importBtn').onclick=()=> $('#csvInput').click();

// ===== Calendar =====
let calYear,calMonth;
function setMonth(y,m){ calYear=y; calMonth=m; $('#monthPicker').value=y+'-'+String(m+1).padStart(2,'0'); renderCalendar(); }
function monthInfo(y,m){ const first=new Date(y,m,1); const last=new Date(y,m+1,0); return {days:last.getDate(), firstDOW:(first.getDay()+6)%7}; }
function renderCalendar(){
  const {days, firstDOW}=monthInfo(calYear, calMonth);
  $('#calTitle').textContent=String(calMonth+1).padStart(2,'0')+'/'+calYear;
  $('#calRange').textContent='(01‚Äì'+String(days).padStart(2,'0')+')';
  const grid=$('#calendarGrid'); grid.innerHTML='';
  const rs=rows();
  const prevDays = new Date(calYear, calMonth, 0).getDate();
  const totalCells=42; let day=1, next=1;
  const fmt=(y,m,d)=> y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
  for(let i=0;i<totalCells;i++){
    const cell=document.createElement('div'); cell.className='day';
    let shown, inMonth=true, dnum;
    if(i<firstDOW){ inMonth=false; const pm=calMonth-1<0?11:calMonth-1; const py=calMonth-1<0?calYear-1:calYear; dnum=prevDays-firstDOW+i+1; shown=fmt(py,pm,dnum); }
    else if(day<=days){ dnum=day++; shown=fmt(calYear,calMonth,dnum); }
    else { inMonth=false; const nm=(calMonth+1)%12; const ny=calMonth+1>11?calYear+1:calYear; dnum=next++; shown=fmt(ny,nm,dnum); }
    if(!inMonth) cell.classList.add('other');
    let inc=0,exp=0; rs.forEach(r=>{ if(r.date===shown){ if(r.type==='income') inc+=Number(r.amount||0); else exp+=Number(r.amount||0); } });
    cell.innerHTML=`<h4>${dnum}</h4><div class="dmoney"><span class="inc">${inc?money(inc):''}</span><span class="exp">${exp?money(exp):''}</span></div>`;
    cell.onclick=()=>showDayDetail(shown);
    grid.appendChild(cell);
  }
}
function showDayDetail(dateStr){
  $('#detailDate').textContent=dateStr;
  const body=$('#detailBody'); body.innerHTML='';
  rows().filter(r=>r.date===dateStr).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="pill ${r.type==='income'?'income':'expense'}">${r.type==='income'?'Thu':'Chi'}</span></td>
      <td>${r.category||''}</td><td>${r.note||''}</td><td class="right">${money(r.amount)}</td>`;
    body.appendChild(tr);
  });
}
$('#prevMonth').onclick=()=>{ const m=calMonth-1; if(m<0){ calMonth=11; calYear--; } else calMonth=m; renderCalendar(); };
$('#nextMonth').onclick=()=>{ const m=calMonth+1; if(m>11){ calMonth=0; calYear++; } else calMonth=m; renderCalendar(); };
$('#monthPicker').addEventListener('change', e=>{ const [y,m]=e.target.value.split('-'); setMonth(Number(y), Number(m)-1); });

// ===== Reports =====
let repMode='monthly', repType='expense';
function palette(i){ const P=['#60a5fa','#34d399','#fbbf24','#f87171','#a78bfa','#f472b6','#22d3ee','#fb923c','#4ade80','#c084fc']; return P[i%P.length]; }
function drawDonut(values, labels){
  const canvas=$('#donut'); const ctx=canvas.getContext('2d');
  const w=Math.min(300, Math.max(220, canvas.parentElement.clientWidth-40));
  canvas.width=w; canvas.height=w;
  ctx.clearRect(0,0,w,w);
  const cx=w/2, cy=w/2, r=w/2-14, r2=r*0.58;
  const total=values.reduce((a,b)=>a+b,0)||1; let ang=-Math.PI/2;
  values.forEach((v,i)=>{ const a=(v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,ang+a); ctx.closePath(); ctx.fillStyle=palette(i); ctx.fill(); ang+=a; });
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over'; ctx.fillStyle='#111827'; ctx.textAlign='center'; ctx.font='700 14px system-ui'; ctx.fillText('T·ªïng: '+money(total), cx, cy+6);
}
function renderReport(){
  const all=rows();
  let filtered=[];
  if(repMode==='monthly'){ const [yy,mm]=$('#reportMonth').value.split('-'); const y=Number(yy), m=Number(mm); filtered=all.filter(r=>{const [ry,rm]=r.date.split('-').map(Number); return ry===y && rm===m;}); }
  else { const y=Number($('#reportYear').value||new Date().getFullYear()); filtered=all.filter(r=>Number(r.date.split('-')[0])===y); }
  const list=filtered.filter(r=>r.type===repType);
  const map=new Map(); list.forEach(r=> map.set(r.category,(map.get(r.category)||0)+Number(r.amount||0)));
  const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]);
  const labels=arr.map(x=>x[0]); const values=arr.map(x=>x[1]);
  drawDonut(values, labels);
  const legend=$('#legend'); legend.innerHTML='';
  const total=values.reduce((a,b)=>a+b,0);
  if(!arr.length){ legend.innerHTML='<div class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</div>'; return; }
  arr.forEach((e,i)=>{
    const d=document.createElement('div'); d.className='legend-item';
    const pct= total? (e[1]*100/total):0;
    d.innerHTML=`<div style="display:flex; align-items:center; gap:8px"><span class="lbox" style="background:${palette(i)}"></span><strong>${e[0]}</strong></div>
      <div>${money(e[1])} <span class="muted">(${pct.toFixed(1)}%)</span></div>`;
    legend.appendChild(d);
  });
}
$('#btnMonthly').onclick=()=>{ repMode='monthly'; $('#btnMonthly').classList.add('active'); $('#btnYearly').classList.remove('active'); $('#reportYear').style.display='none'; $('#reportMonth').style.display='inline-block'; renderReport(); };
$('#btnYearly').onclick=()=>{ repMode='yearly'; $('#btnYearly').classList.add('active'); $('#btnMonthly').classList.remove('active'); $('#reportMonth').style.display='none'; $('#reportYear').style.display='inline-block'; renderReport(); };
$('#btnRepExpense').onclick=()=>{ repType='expense'; $('#btnRepExpense').classList.add('active'); $('#btnRepIncome').classList.remove('active'); renderReport(); };
$('#btnRepIncome').onclick=()=>{ repType='income'; $('#btnRepIncome').classList.add('active'); $('#btnRepExpense').classList.remove('active'); renderReport(); };
$('#reportMonth').addEventListener('change', renderReport);
$('#reportYear').addEventListener('change', renderReport);

// ===== Init =====
$('#dateInput').value=todayStr();
$('#reportMonth').value=todayStr().slice(0,7);
$('#reportYear').value=new Date().getFullYear();
renderCats(); renderTable();
const d=new Date(); setMonth(d.getFullYear(), d.getMonth()); showDayDetail(todayStr());
renderReport();
</script>
</body>
</html>
